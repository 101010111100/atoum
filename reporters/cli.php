<?php

namespace mageekguy\atoum\reporters;

use \mageekguy\atoum;

class cli extends atoum\reporter
{
	protected $run = 0;
	protected $start = 0.0;
	protected $progressBar = 0;
	protected $padding = 0;
	protected $currentMethod = '';
	protected $testMethods = 0;
	protected $testMethodNumber = 0;

	protected function runStart(atoum\runner $runner)
	{
		$this->start = microtime(true);

		self::write(sprintf($this->locale->_('Atoum version %s by %s.'), atoum\test::getVersion(), atoum\test::author));

		return $this;
	}

	protected function testRunStart(atoum\test $test)
	{
		$this->run++;
		$this->progressBar = 0;
		$this->testMethods = 0;
		$this->testMethodNumber = sizeof($test);

		self::write(sprintf($this->locale->_('Run %s...'), $test->getClass()));
	}

	protected function beforeTestMethod(atoum\test $test)
	{
		$this->testMethods++;
		$this->currentMethod = $test->getCurrentMethod();
		$this->progressBar();
		return $this;
	}

	protected function afterTestMethod(atoum\test $test)
	{
		$this->currentMethod = '';
		$this->progressBar();
		return $this;
	}

	protected function success(atoum\test $test)
	{
		return $this->progressBar('.');
	}

	protected function failure(atoum\test $test)
	{
		return $this->progressBar('F');
	}

	protected function error(atoum\test $test)
	{
		return $this->progressBar('!');
	}

	protected function exception(atoum\test $test)
	{
		return $this->progressBar('!');
	}

	protected function testRunEnd(atoum\test $test)
	{
		$score = $test->getScore();

		$failNumber = $score->getFailNumber();
		$errorNumber = $score->getErrorNumber();
		$exceptionNumber = $score->getExceptionNumber();
		$outputNumber = $score->getOutputNumber();
		$duration = $score->getTotalDuration();

		self::write();

		self::write(sprintf($this->locale->__('Duration: %4.2f second.', 'Duration: %4.2f seconds.', $duration), $duration));
		self::write(sprintf($this->locale->_('Memory usage: %4.2f Mb.'), $score->getTotalMemoryUsage() / 1048576));

		if ($failNumber > 0)
		{
			self::write(sprintf($this->locale->_('Failure ! (%s, %s, %s)'), sprintf($this->locale->__('%d test', '%d tests', $this->testMethodNumber), $this->testMethodNumber), sprintf($this->locale->__('%d assertion', '%d assertions', $score->getAssertionNumber()), $score->getAssertionNumber()), sprintf($this->locale->__('%d failure', '%d failures', $failNumber), $failNumber)));
		}
		else
		{
			$problemNumber = $errorNumber + $exceptionNumber;

			if ($problemNumber === 0)
			{
				self::write(sprintf($this->locale->_('Success (%s, %s) !'), sprintf($this->locale->__('%d test', '%d tests', $this->testMethodNumber), $this->testMethodNumber), sprintf($this->locale->__('%d assertion', '%d assertions', $score->getAssertionNumber()), $score->getAssertionNumber())));
			}
			else
			{
				self::write(sprintf($this->locale->__('Success (%s, %s), but there is %s problem...', 'Success (%s, %s), but there are %s problems...', $problemNumber), sprintf($this->locale->__('%d test', '%d tests', $this->testMethodNumber), $this->testMethodNumber), sprintf($this->locale->__('%d assertion', '%d assertions', $score->getAssertionNumber()), $score->getAssertionNumber()), $problemNumber));
			}
		}

		if ($outputNumber > 0)
		{
			self::write($this->locale->_('Output:'));

			foreach ($score->getOutputs() as $output)
			{
				self::write($output['class'] . '::' . $output['method'] . '():', 1);

				foreach (explode("\n", trim($output['value'])) as $line)
				{
					self::write($line, 2);
				}
			}
		}

		if ($failNumber > 0)
		{
			self::write(sprintf($this->locale->__('There is %d failure', 'There are %d failures', $failNumber), $failNumber) . ':');

			foreach ($score->getFailAssertions() as $assertion)
			{
				self::write($assertion['class'] . '::' . $assertion['method'] . '():', 1);
				self::write(sprintf('%s failed because %s in file %s at line %d', $assertion['asserter'], $assertion['fail'], $assertion['file'], $assertion['line']), 2);
			}
		}

		if ($errorNumber > 0)
		{
			self::write(sprintf($this->locale->__('There is %d error', 'There are %d errors', $errorNumber), $errorNumber) . ':');

			foreach ($score->getErrors() as $error)
			{
				self::write($error['class'] . '::' . $error['method'] . '():', 1);
				self::write(sprintf($this->locale->_('Error %s with message \'%s\' generated by file %s at line %d'), self::getErrorLabel($error['type']), $error['message'], $error['file'], $error['line']), 2);
			}
		}

		if ($exceptionNumber > 0)
		{
			self::write(sprintf($this->locale->__('There is %d exception', 'There are %d exceptions', $exceptionNumber), $exceptionNumber) . ':');

			foreach ($score->getExceptions() as $exception)
			{
				self::write($exception['class'] . '::' . $exception['method'] . '():', 1);

				foreach (explode("\n", $exception['value']) as $line)
				{
					self::write($line, 2);
				}
			}
		}

		return $this;
	}

	protected function runEnd(atoum\runner $runner)
	{
		$duration = microtime(true) - $this->start;

		self::write(sprintf($this->locale->__('Total duration: %4.2f second.', 'Total duration: %4.2f seconds.', $duration), $duration));
		self::write(sprintf($this->locale->_('Total memory usage: %4.2f Mb.'), memory_get_peak_usage(true) / 1048576));

		return $this;
	}

	protected function progressBar($dot = '')
	{
		$end = '[' . sprintf('%' . strlen($this->testMethodNumber) . 'd', $this->testMethods) . '/' . $this->testMethodNumber . ']';

		if ($this->padding > 0)
		{
			echo str_repeat("\010", $this->padding);
		}

		if ($this->progressBar >= 60)
		{
			self::write($end);
			$this->progressBar = 0;
		}

		if ($dot != '')
		{
			$this->progressBar++;
		}

		$maxPadding = 60 - $this->progressBar;

		$padding = str_pad(str_repeat('?', min($maxPadding, $this->testMethodNumber - $this->testMethods)), $maxPadding, '_', STR_PAD_RIGHT) . $end . ' ' . $this->currentMethod;

		echo $dot . $padding;

		$this->padding = strlen($padding);

		return $this;
	}

	public static function write($message = '', $level = 0)
	{
		if ($message != '')
		{
			echo ($level <= 0 ? '' : str_repeat('   ', $level)) . ltrim($message);
		}

		echo PHP_EOL;
	}
}

?>
